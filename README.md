## Reporting tool

 v 1.0
-   
A Spring boot application providing an REST API to generate Reservation report.  
  The reservation report captures the reservations done for a restaurant booking.  
  A reservation provides the information about the reservor and number of people they have booked for.  
  The application currently has endpoints for generating a visit summary
  A sample reservation input looks like this
```json
{
    "reservation_id": "5fb66b846d7e1ba76c29a329",
    "party_size": 6,
    "scheduled_date": "2020-11-26",
    "total_spend": 97.84,
    "guest": {
      "id": "1004",
      "name": "Felix Fish"
    }
  }
```

Following are few strategies used in the application. 
- In-memory H2 database for local development. This application is currently developed for local development only.
- Querydsl API for data persistence and querying. I've chosen this library to provide type safety and to provision for build queries with dynamic order by expressions.
- The DAO layer is build on top of the EntityManager. The querying of database is build using JPAQueryFactory.
- CommandLineRunner to load the sample data from reservations.json to in-memory database
- Custom validator for validating input request date range and date bound
- Exception handling for invalid sort strategy provided.
- Custom ErrorResponse for any exception in application


### Software required

- JDK version 11
- Maven 3.8.4
- Spring 2.7


### Steps before we can run the application

Since the application uses QueryDsl it requires autogenerated Q-types.  
These Q-types will provide the wrapper to build fluent query API.  
The maven plugin for generating those beans is provided in the pom.xml.
To generate the Q-types run the following command in terminal

```bash
mvn compile
```

### Testing the application using test cases
- At the root of the application you can use the mvn command to execute the test

```bash
mvn -Dtest=CrudServiceTest test
mvn -Dtest=ReportControllerTest test
mvn -Dtest=ReportServiceTest test
```

- Or for all tests

```bash
mvn test
```
  

### Running the application in local

```bash
mvn spring-boot:run
```
You could use curl or Postman to test the application  

http://localhost:8080/reports/visits

Sample input  

Request
```json
{
  "dateRange": {
    "start": "2000-11-20",
    "end": "2022-11-20"
  },
  "sortExpressions": [
    {
      "fieldName": "guestName",
      "sortOrder": "desc"
    }
  ]
}
```
Response
```aidl
{
    "reservationSummaries": [
        {
            "guestName": "Rock Lobster",
            "totalVisits": 1,
            "totalSpend": 64.55
        },
        {
            "guestName": "Jack Rabbit",
            "totalVisits": 1,
            "totalSpend": 55.10
        },
        {
            "guestName": "Harry Houdini",
            "totalVisits": 3,
            "totalSpend": 211.18
        },
        {
            "guestName": "Felix Fish",
            "totalVisits": 3,
            "totalSpend": 251.12
        }
    ]
}
```
Invalid Input
Request
```json
{
    "dateRange": {
        "start": "2023-11-20",
        "end": "2022-11-20"
    },
    "sortExpressions": [
        {
            "fieldName": "guestName",
            "sortOrder": "desc"
        }
    ]
}
```

Response
```json
{
    "status": 400,
    "message": "Input Validation error.",
    "errors": [
        {
            "field": "dateRange",
            "message": "Date is out of bound. Please provide a valid date range where start is not greater than end"
        }
    ]
}
```

Invalid input
Request
```json
{
    "dateRange": {
        "start": "2020-11-20",
        "end": "2022-11-20"
    },
    "sortExpressions": [
        {
            "fieldName": "guestNme",
            "sortOrder": "desc"
        }
    ]
}
```

Response
```json
{
    "status": 400,
    "message": "Unsupported sort field name -> guestNme"
}
```